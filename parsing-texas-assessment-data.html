
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/monokai.min.css">


  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">

    <link rel="stylesheet" type="text/css" href="./static/custom.css">

    <link href="http://dchess.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="dchess Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  


 

<meta name="author" content="dc.hess@gmail.com" />
<meta name="description" content="Demo of using pandas to pivot jagged ultra-wide dataset into a consistent and long format." />
<meta name="keywords" content="">


  <meta property="og:site_name" content="dchess"/>
  <meta property="og:title" content="Parsing Texas Assessment Data"/>
  <meta property="og:description" content="Demo of using pandas to pivot jagged ultra-wide dataset into a consistent and long format."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./parsing-texas-assessment-data.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-01-29 21:00:00-07:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="./author/dchessgmailcom.html">
  <meta property="article:section" content="Tutorial"/>
  <meta property="og:image" content="/images/profile.jpg">

  <title>dchess &ndash; Parsing Texas Assessment Data</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="./">
        <img src="/images/profile.jpg" alt="D.C. Hess" title="D.C. Hess">
      </a>

      <h1>
        <a href="./">D.C. Hess</a>
      </h1>

<p>Software Engineer</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="./pages/about-me.html#about-me">
                  About Me
                </a>
              </li>

            <li>
              <a target="_self" href="https://drive.google.com/file/d/1O0-Le26SdL-DhDo2LsOQVWR5BAV4I17F/view" >resume</a>
            </li>
            <li>
              <a target="_self" href="https://sqlsorcery.readthedocs.io/en/latest/" >SQLSorcery</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://www.github.com/dchess" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/dc_hess" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/dchess" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="./">Home</a>

      <a href="/category/projects.html">Projects</a>
      <a href="/category/tutorial.html">Tutorial</a>

      <a href="http://dchess.github.io/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="parsing-texas-assessment-data">Parsing Texas Assessment Data</h1>
    <p>
      Posted on Sat 29 January 2022 in <a href="./category/tutorial.html">Tutorial</a>

    </p>
  </header>


  <div>
    <div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Data-Transformation-of-the-Texas-STAAR-Aggregate-Data-for-2020-2021">Data Transformation of the Texas STAAR Aggregate Data for 2020-2021<a class="anchor-link" href="#Data-Transformation-of-the-Texas-STAAR-Aggregate-Data-for-2020-2021">&#182;</a></h1><p>Data files available <a href="https://tea.texas.gov/student-assessment/testing/staar/staar-aggregate-data-for-2020-2021">here on the TEA website</a>.</p>
<p>The STAAR data files contain results for 60+ student demographic groups and each variable is repeated in a separate column for both demographic and test subject. As you will see below, this results in data files that are several thousand columns wide and are a different schema for every grade.</p>
<p>These files are designed for use in SAS and SPSS, and the website itself indicates that the number of variables in these files is too great to import into Microsoft Access or some versions of Microsoft Excel without significant truncation.</p>
<p>However, my goal was to pivot this data into a standardized format and load into BigQuery for cross analysis with other state assessment data. What follows is my approach in Python, but I am sure there are other potentially simpler methods than mine, I hope this demonstration helps other approach this dataset for analysis and possibly encourages others to improve upon this method.</p>
<p>The original files are linked below for easy access.</p>
<p><strong>Campus level data for Grades 3-8</strong></p>
<ul>
<li><strong>Grade 3:</strong>  <a href="https://tea.texas.gov/sites/default/files/cfy21e3.dat">test data</a> | <a href="https://tea.texas.gov/sites/default/files/fy21_varlist_g03.xls">variable list</a></li>
<li><strong>Grade 4:</strong> <a href="https://tea.texas.gov/sites/default/files/cfy21e4.dat">test data</a> | <a href="https://tea.texas.gov/sites/default/files/fy21_varlist_g04.xls">variable list</a></li>
<li><strong>Grade 5:</strong> <a href="https://tea.texas.gov/sites/default/files/cfy21e5.dat">test data</a> | <a href="https://tea.texas.gov/sites/default/files/fy21_varlist_g05.xls">variable list</a></li>
<li><strong>Grade 6:</strong> <a href="https://tea.texas.gov/sites/default/files/cfy21e6.dat">test data</a> | <a href="https://tea.texas.gov/sites/default/files/fy21_varlist_g06.xls">variable list</a></li>
<li><strong>Grade 7:</strong> <a href="https://tea.texas.gov/sites/default/files/cfy21e7.dat">test data</a> | <a href="https://tea.texas.gov/sites/default/files/fy21_varlist_g07.xls">variable list</a></li>
<li><strong>Grade 8:</strong> <a href="https://tea.texas.gov/sites/default/files/cfy21e8.dat">test data</a> | <a href="https://tea.texas.gov/sites/default/files/fy21_varlist_g08.xls">variable list</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Getting-the-Lay-of-the-Land">Getting the Lay of the Land<a class="anchor-link" href="#Getting-the-Lay-of-the-Land">&#182;</a></h2><p>Before determining a solution and final schema, I wanted to understand the structure of these files. This can be accomplished by looping over the linked dat files and getting their shapes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[46]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[47]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://tea.texas.gov/sites/default/files/&quot;</span>
<span class="n">dat_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cfy21e3.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e4.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e5.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e6.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e7.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e8.dat&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">dat_file</span> <span class="ow">in</span> <span class="n">dat_files</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">dat_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>cfy21e3 (4643, 2093)
cfy21e4 (4622, 3075)
cfy21e5 (4415, 3197)
cfy21e6 (2700, 2093)
cfy21e7 (2337, 3075)
cfy21e8 (2370, 4301)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Each file is named with this convention (as far as I can discern):</p>
<ul>
<li><strong>c</strong>: Campus level data</li>
<li><strong>fy21</strong>: Fiscal year 2021</li>
<li><strong>e#</strong>: English grade # (English, because grades 3-5 also include Spanish results)</li>
</ul>
<p>The numbers in the accompanying parenthesis represent the count of rows and columns, respectively.</p>
<h2 id="Inconsistent-Data-Shape">Inconsistent Data Shape<a class="anchor-link" href="#Inconsistent-Data-Shape">&#182;</a></h2><p>We can see from this quick file inspection that combining these datasets into a single unified structure will require more than just concatenation. The number of columns is jagged/inconsistent. Reviewing the variable files shows that each grade has differences in the variables reported. Some grades have Reading and Mathematics, while other include a Writing test as well. There are additional differences, but that is one of the most common.</p>
<p>They are so wide, because each variable such as <code># Tested</code> is repeated for each subject and each student group (60+ in total). We can also see that the naming of these columns is encoded/abbreviated, such as <code>r_all_d</code> for <code># Tested -- Reading -- All Students</code> or <code>r_eth2_d</code> for <code># Tested -- Reading -- Two or More Races Students</code>.</p>
<h2 id="Finding-a-Pattern">Finding a Pattern<a class="anchor-link" href="#Finding-a-Pattern">&#182;</a></h2><p>There is something of a pattern to this naming convention you may have noticed:</p>
<ul>
<li><strong>r</strong>: reading</li>
<li><strong>all</strong>: all students</li>
<li><strong>d</strong>: # tested</li>
</ul>
<p>This becomes more obvious with subsequent examples such as <code>r_all_unsatgl_nm</code> for <code># Did Not Meet Grade Level Performance -- Reading -- All Students</code>.</p>
<h2 id="A-First-Attempt">A First Attempt<a class="anchor-link" href="#A-First-Attempt">&#182;</a></h2><p>My initial thought was to split these variable names using the the <code>_</code> as a delimiter, but this was met with limited success, again due to inconsistent usage.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[49]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grade3_vars</span> <span class="o">=</span> <span class="s1">&#39;https://tea.texas.gov/sites/default/files/fy21_varlist_g03.xls&#39;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">grade3_vars</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
</pre>
</div>
</div>

<div class="output_area">

    <div class="prompt output_prompt">Out[49]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>campus</td>
      <td>Character</td>
      <td>Campus Number</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>Character</td>
      <td>Test Administration Year</td>
    </tr>
    <tr>
      <th>2</th>
      <td>region</td>
      <td>Character</td>
      <td>Education Service Center (Region) Number</td>
    </tr>
    <tr>
      <th>3</th>
      <td>district</td>
      <td>Character</td>
      <td>District Number</td>
    </tr>
    <tr>
      <th>4</th>
      <td>dname</td>
      <td>Character</td>
      <td>District Name</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cname</td>
      <td>Character</td>
      <td>Campus Name</td>
    </tr>
    <tr>
      <th>6</th>
      <td>grade</td>
      <td>Character</td>
      <td>Tested Grade (Usually the Enrolled Grade Unles...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>r_all_docs_n</td>
      <td>Numeric</td>
      <td># Answer Documents Submitted -- Reading -- All...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>r_all_abs_n</td>
      <td>Numeric</td>
      <td># Absent - Not Tested -- Reading -- All Students</td>
    </tr>
    <tr>
      <th>9</th>
      <td>r_all_oth_n</td>
      <td>Numeric</td>
      <td># Other - Not Tested -- Reading -- All Students</td>
    </tr>
    <tr>
      <th>10</th>
      <td>m_all_docs_n</td>
      <td>Numeric</td>
      <td># Answer Documents Submitted -- Mathematics --...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>m_all_abs_n</td>
      <td>Numeric</td>
      <td># Absent - Not Tested -- Mathematics -- All St...</td>
    </tr>
    <tr>
      <th>12</th>
      <td>m_all_oth_n</td>
      <td>Numeric</td>
      <td># Other - Not Tested -- Mathematics -- All Stu...</td>
    </tr>
    <tr>
      <th>13</th>
      <td>r_all_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- All Students</td>
    </tr>
    <tr>
      <th>14</th>
      <td>r_sexm_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Male Students</td>
    </tr>
    <tr>
      <th>15</th>
      <td>r_sexf_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Female Students</td>
    </tr>
    <tr>
      <th>16</th>
      <td>r_sexv_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- No Sex Info Students</td>
    </tr>
    <tr>
      <th>17</th>
      <td>r_ethh_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Hispanic/Latino Students</td>
    </tr>
    <tr>
      <th>18</th>
      <td>r_ethi_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- American Indian or Alas...</td>
    </tr>
    <tr>
      <th>19</th>
      <td>r_etha_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Asian Students</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It appears at first glance, that the pattern is subject, student demographic group, variable type. However, we can see this doesn't remain consistent.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[12]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2078</th>
      <td>m_spen_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2079</th>
      <td>m_spev_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2080</th>
      <td>m_spev_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2081</th>
      <td>m_gify_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2082</th>
      <td>m_gify_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2083</th>
      <td>m_gifn_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2084</th>
      <td>m_gifn_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2085</th>
      <td>m_gifv_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2086</th>
      <td>m_gifv_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2087</th>
      <td>m_atry_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2088</th>
      <td>m_atry_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2089</th>
      <td>m_atrn_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2090</th>
      <td>m_atrn_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2091</th>
      <td>m_atrv_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
    <tr>
      <th>2092</th>
      <td>m_atrv_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In these latter cases, there is a 4th variable reporting category that comes before the subject and student group.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="mi">195</span><span class="p">:</span><span class="mi">215</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[15]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>195</th>
      <td>r_atrv_unsatgl_nm</td>
      <td>Numeric</td>
      <td># Did Not Meet Grade Level Performance -- Read...</td>
    </tr>
    <tr>
      <th>196</th>
      <td>r_all_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>197</th>
      <td>r_sexm_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>198</th>
      <td>r_sexf_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>199</th>
      <td>r_sexv_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>200</th>
      <td>r_ethh_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>201</th>
      <td>r_ethi_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>202</th>
      <td>r_etha_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>203</th>
      <td>r_ethb_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>204</th>
      <td>r_ethp_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>205</th>
      <td>r_ethw_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>206</th>
      <td>r_eth2_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>207</th>
      <td>r_ethv_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>208</th>
      <td>r_ecoy_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>209</th>
      <td>r_econ_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>210</th>
      <td>r_eco1_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>211</th>
      <td>r_eco2_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>212</th>
      <td>r_eco9_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>213</th>
      <td>r_ecov_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
    <tr>
      <th>214</th>
      <td>r_ti1y_approgl_nm</td>
      <td>Numeric</td>
      <td># Approaches Grade Level Performance -- Readin...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is another pattern with 4 parts for the proficiency levels that is subject, student group, and then a two part string for the variable type.</p>
<p>These differences would make it challenging to simply split on the <code>_</code> character. Even distinguishing between the three part and four part variables isn't sufficient, because there are two types of the four part variables.</p>
<h2 id="A-Different-Solution">A Different Solution<a class="anchor-link" href="#A-Different-Solution">&#182;</a></h2><p>However, we can simply ignore the variables. We have a description column that also has it's own delimiter: <code>--</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[52]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">descriptions</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Description</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;Campus Number&#39;]
[&#39;Test Administration Year&#39;]
[&#39;Education Service Center (Region) Number&#39;]
[&#39;District Number&#39;]
[&#39;District Name&#39;]
[&#39;Campus Name&#39;]
[&#39;Tested Grade (Usually the Enrolled Grade Unless Student Tested Above Grade)&#39;]
[&#39;# Answer Documents Submitted &#39;, &#39; Reading &#39;, &#39; All Students&#39;]
[&#39;# Absent - Not Tested &#39;, &#39; Reading &#39;, &#39; All Students&#39;]
[&#39;# Other - Not Tested &#39;, &#39; Reading &#39;, &#39; All Students&#39;]
[&#39;# Answer Documents Submitted &#39;, &#39; Mathematics &#39;, &#39; All Students&#39;]
[&#39;# Absent - Not Tested &#39;, &#39; Mathematics &#39;, &#39; All Students&#39;]
[&#39;# Other - Not Tested &#39;, &#39; Mathematics &#39;, &#39; All Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; All Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; Male Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; Female Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; No Sex Info Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; Hispanic/Latino Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; American Indian or Alaska Native Students&#39;]
[&#39;# Tested &#39;, &#39; Reading &#39;, &#39; Asian Students&#39;]

...

[&#39;% Avg Items Correct&#39;, &#39;Reporting Category 4 &#39;, &#39; Mathematics &#39;, &#39; At-Risk Students&#39;]
[&#39;# Avg Items Correct&#39;, &#39;Reporting Category 4 &#39;, &#39; Mathematics &#39;, &#39; Not At-Risk Students&#39;]
[&#39;% Avg Items Correct&#39;, &#39;Reporting Category 4 &#39;, &#39; Mathematics &#39;, &#39; Not At-Risk Students&#39;]
[&#39;# Avg Items Correct&#39;, &#39;Reporting Category 4 &#39;, &#39; Mathematics &#39;, &#39; No Info At-Risk Students&#39;]
[&#39;% Avg Items Correct&#39;, &#39;Reporting Category 4 &#39;, &#39; Mathematics &#39;, &#39; No Info At-Risk Students&#39;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This mostly works. We have three different types of descriptions/variables:</p>
<ul>
<li>1 part variables like <code>['Campus Number']</code></li>
<li>3 part variables like <code>['# Tested ', ' Reading ', ' All Students']</code></li>
<li>4 part variables like <code>['% Avg Items Correct', 'Reporting Category 4 ', ' Mathematics ', ' At-Risk Students']</code></li>
</ul>
<p>That means we can use the list length to determine the order of the variable values: variable name, test subject, and student group. The fourth part reporting category is basically a modifier for the variable name so we can combine those.</p>
<p>By examining a single variable name, we can see that <code># Tested</code>, for example, isn't actually 122 different variables but rather a single variable with 122 permutations of test subject and student group: <strong>61 student groups * 2 test subjects</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">Description</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;# Tested&#39;</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[19]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>13</th>
      <td>r_all_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- All Students</td>
    </tr>
    <tr>
      <th>14</th>
      <td>r_sexm_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Male Students</td>
    </tr>
    <tr>
      <th>15</th>
      <td>r_sexf_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Female Students</td>
    </tr>
    <tr>
      <th>16</th>
      <td>r_sexv_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- No Sex Info Students</td>
    </tr>
    <tr>
      <th>17</th>
      <td>r_ethh_d</td>
      <td>Numeric</td>
      <td># Tested -- Reading -- Hispanic/Latino Students</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>130</th>
      <td>m_gifn_d</td>
      <td>Numeric</td>
      <td># Tested -- Mathematics -- Not Gifted/Talented...</td>
    </tr>
    <tr>
      <th>131</th>
      <td>m_gifv_d</td>
      <td>Numeric</td>
      <td># Tested -- Mathematics -- No Info Gifted/Tale...</td>
    </tr>
    <tr>
      <th>132</th>
      <td>m_atry_d</td>
      <td>Numeric</td>
      <td># Tested -- Mathematics -- At-Risk Students</td>
    </tr>
    <tr>
      <th>133</th>
      <td>m_atrn_d</td>
      <td>Numeric</td>
      <td># Tested -- Mathematics -- Not At-Risk Students</td>
    </tr>
    <tr>
      <th>134</th>
      <td>m_atrv_d</td>
      <td>Numeric</td>
      <td># Tested -- Mathematics -- No Info At-Risk Stu...</td>
    </tr>
  </tbody>
</table>
<p>122 rows × 3 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Extracting-the-Variable-Descriptors">Extracting the Variable Descriptors<a class="anchor-link" href="#Extracting-the-Variable-Descriptors">&#182;</a></h2><p>In addition to pulling out the test subject and student group from the variable description, it will be useful to rename the columns into a common naming convention that is more human readable than the current encodings.</p>
<p><strong>Example</strong>:</p>
<p>If we take the initial variable example <code>r_all_d</code> for <code># Tested -- Reading -- All Students</code> and remove the subject and student group we would be left with simply <code>d</code> as the variable/column name. But a better description would be <code># Tested</code> or even better (to eliminate special characters that would be problematic in the database) <code>n_tested</code>.</p>
<h3 id="Splitting-the-Description">Splitting the Description<a class="anchor-link" href="#Splitting-the-Description">&#182;</a></h3><p>To start let's add a new column to the dataframe that has the array of descriptors. We can also remove any leading or trailing whitespace from both the variable and description to prevent mismatch issues later.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[25]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
      <th>desc_list</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>campus</td>
      <td>Character</td>
      <td>Campus Number</td>
      <td>[Campus Number]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>Character</td>
      <td>Test Administration Year</td>
      <td>[Test Administration Year]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>region</td>
      <td>Character</td>
      <td>Education Service Center (Region) Number</td>
      <td>[Education Service Center (Region) Number]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>district</td>
      <td>Character</td>
      <td>District Number</td>
      <td>[District Number]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>dname</td>
      <td>Character</td>
      <td>District Name</td>
      <td>[District Name]</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2088</th>
      <td>m_atry_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
    </tr>
    <tr>
      <th>2089</th>
      <td>m_atrn_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
    </tr>
    <tr>
      <th>2090</th>
      <td>m_atrn_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
    </tr>
    <tr>
      <th>2091</th>
      <td>m_atrv_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
    </tr>
    <tr>
      <th>2092</th>
      <td>m_atrv_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
    </tr>
  </tbody>
</table>
<p>2093 rows × 4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Extracting-Test-Subject">Extracting Test Subject<a class="anchor-link" href="#Extracting-Test-Subject">&#182;</a></h3><p>In most cases the test subject is the 2nd part of the variable description with two exceptions: if the variable is one of the campus/grade variables that only has a single part or for the four part variables that include reporting category.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_subject</span><span class="p">(</span><span class="n">desc_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the 2nd part of 3 part descriptors, the 3rd part of 4 part descriptors, or None.</span>

<span class="sd">    Note: Else None is not necessary here, since functions return None by default in Python</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">desc_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">desc_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_subject</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[27]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
      <th>desc_list</th>
      <th>subject</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>campus</td>
      <td>Character</td>
      <td>Campus Number</td>
      <td>[Campus Number]</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>Character</td>
      <td>Test Administration Year</td>
      <td>[Test Administration Year]</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>region</td>
      <td>Character</td>
      <td>Education Service Center (Region) Number</td>
      <td>[Education Service Center (Region) Number]</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>district</td>
      <td>Character</td>
      <td>District Number</td>
      <td>[District Number]</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>dname</td>
      <td>Character</td>
      <td>District Name</td>
      <td>[District Name]</td>
      <td>None</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2088</th>
      <td>m_atry_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
    </tr>
    <tr>
      <th>2089</th>
      <td>m_atrn_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
    </tr>
    <tr>
      <th>2090</th>
      <td>m_atrn_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
    </tr>
    <tr>
      <th>2091</th>
      <td>m_atrv_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
    </tr>
    <tr>
      <th>2092</th>
      <td>m_atrv_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
    </tr>
  </tbody>
</table>
<p>2093 rows × 5 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Extracting-Student-Group">Extracting Student Group<a class="anchor-link" href="#Extracting-Student-Group">&#182;</a></h2><p>In all cases (except the single descriptor variables) the student group is included at the end of the description.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[29]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_student_group</span><span class="p">(</span><span class="n">desc_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unless the description has only one part, return the final part.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">desc_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[30]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;student_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_student_group</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[30]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
      <th>desc_list</th>
      <th>subject</th>
      <th>student_group</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>campus</td>
      <td>Character</td>
      <td>Campus Number</td>
      <td>[Campus Number]</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>Character</td>
      <td>Test Administration Year</td>
      <td>[Test Administration Year]</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>region</td>
      <td>Character</td>
      <td>Education Service Center (Region) Number</td>
      <td>[Education Service Center (Region) Number]</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>district</td>
      <td>Character</td>
      <td>District Number</td>
      <td>[District Number]</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>dname</td>
      <td>Character</td>
      <td>District Name</td>
      <td>[District Name]</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2088</th>
      <td>m_atry_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>At-Risk Students</td>
    </tr>
    <tr>
      <th>2089</th>
      <td>m_atrn_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>Not At-Risk Students</td>
    </tr>
    <tr>
      <th>2090</th>
      <td>m_atrn_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>Not At-Risk Students</td>
    </tr>
    <tr>
      <th>2091</th>
      <td>m_atrv_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>No Info At-Risk Students</td>
    </tr>
    <tr>
      <th>2092</th>
      <td>m_atrv_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>No Info At-Risk Students</td>
    </tr>
  </tbody>
</table>
<p>2093 rows × 6 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-a-New-Variable-Name">Creating a New Variable Name<a class="anchor-link" href="#Creating-a-New-Variable-Name">&#182;</a></h2><p>There are a few problematic characters like <code>#</code> and <code>%</code> in the names of the variables that should be replaced as well as replacing spaces and abbreviating some longer words in the names.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[33]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">rename_variable</span><span class="p">(</span><span class="n">desc_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace special characters and append reporting category when present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable_name</span> <span class="o">=</span> <span class="n">desc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">variable_name</span> <span class="o">+=</span> <span class="n">desc_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;#&#39;</span><span class="p">:</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%&#39;</span><span class="p">:</span> <span class="s1">&#39;pct&#39;</span><span class="p">,</span>
        <span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="s1">&#39;avg&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reporting category&#39;</span><span class="p">:</span> <span class="s1">&#39;rpt cat&#39;</span><span class="p">,</span>
        <span class="s1">&#39; &#39;</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span>
        <span class="s1">&#39;__&#39;</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">variable_name</span> <span class="o">=</span> <span class="n">variable_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">variable_name</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rename_variable</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[34]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Format_Type</th>
      <th>Description</th>
      <th>desc_list</th>
      <th>subject</th>
      <th>student_group</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>campus</td>
      <td>Character</td>
      <td>Campus Number</td>
      <td>[Campus Number]</td>
      <td>None</td>
      <td>None</td>
      <td>campus_number</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>Character</td>
      <td>Test Administration Year</td>
      <td>[Test Administration Year]</td>
      <td>None</td>
      <td>None</td>
      <td>test_administration_year</td>
    </tr>
    <tr>
      <th>2</th>
      <td>region</td>
      <td>Character</td>
      <td>Education Service Center (Region) Number</td>
      <td>[Education Service Center (Region) Number]</td>
      <td>None</td>
      <td>None</td>
      <td>education_service_center_region_number</td>
    </tr>
    <tr>
      <th>3</th>
      <td>district</td>
      <td>Character</td>
      <td>District Number</td>
      <td>[District Number]</td>
      <td>None</td>
      <td>None</td>
      <td>district_number</td>
    </tr>
    <tr>
      <th>4</th>
      <td>dname</td>
      <td>Character</td>
      <td>District Name</td>
      <td>[District Name]</td>
      <td>None</td>
      <td>None</td>
      <td>district_name</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2088</th>
      <td>m_atry_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>At-Risk Students</td>
      <td>pct_avg_items_correctrpt_cat_4</td>
    </tr>
    <tr>
      <th>2089</th>
      <td>m_atrn_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>Not At-Risk Students</td>
      <td>n_avg_items_correctrpt_cat_4</td>
    </tr>
    <tr>
      <th>2090</th>
      <td>m_atrn_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>Not At-Risk Students</td>
      <td>pct_avg_items_correctrpt_cat_4</td>
    </tr>
    <tr>
      <th>2091</th>
      <td>m_atrv_avg_cat4</td>
      <td>Numeric</td>
      <td># Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[# Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>No Info At-Risk Students</td>
      <td>n_avg_items_correctrpt_cat_4</td>
    </tr>
    <tr>
      <th>2092</th>
      <td>m_atrv_pct_cat4</td>
      <td>Numeric</td>
      <td>% Avg Items Correct--Reporting Category 4 -- M...</td>
      <td>[% Avg Items Correct, Reporting Category 4 ,  ...</td>
      <td>Mathematics</td>
      <td>No Info At-Risk Students</td>
      <td>pct_avg_items_correctrpt_cat_4</td>
    </tr>
  </tbody>
</table>
<p>2093 rows × 7 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Bringing-it-All-Together">Bringing it All Together<a class="anchor-link" href="#Bringing-it-All-Together">&#182;</a></h2><p>Because we're going to iterate over each variable list (there are six files: one for each grade between 3 and 8), we can simplify this by running all these change operations at once. We also want to remove unneeded columns and rename the original columns to standardize the naming conventions and make for an easy join condition later.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[35]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">add_descriptors</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rename_variable</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_subject</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;student_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;desc_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_student_group</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="s2">&quot;desc_list&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Format_Type&#39;</span><span class="p">:</span> <span class="s1">&#39;format_type&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="A-Path-Forward">A Path Forward<a class="anchor-link" href="#A-Path-Forward">&#182;</a></h2><p>That means it would be possible to pivot this data long for each distinct variable after extracting the subject and student group from the variable description. This information, though, is split across two different files: the test data in the <code>.dat</code> files and the variable descriptions in the <code>.xls</code> files.</p>
<p><strong>My plan then is to:</strong></p>
<ol>
<li>Match the corresponding dat file to its variable list</li>
<li>Pivot the test data long so that each variable and value is a single row</li>
<li>Extract the test subject and student group data points from the variable description</li>
<li>Join the two datasets together using the variable name as a unique identifier</li>
<li>Once more pivot the combined data such that each distinct variable becomes its own column</li>
<li>Combine those standardized data structures for each grade into a single dataset</li>
<li>Write that new dataset out to a compressed csv file for importing into BigQuery</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[40]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://tea.texas.gov/sites/default/files/&quot;</span>
<span class="n">dat_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cfy21e3.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e4.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e5.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e6.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e7.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;cfy21e8.dat&quot;</span><span class="p">]</span>
<span class="n">var_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fy21_varlist_g03.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;fy21_varlist_g04.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;fy21_varlist_g05.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;fy21_varlist_g06.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;fy21_varlist_g07.xls&quot;</span><span class="p">,</span> <span class="s2">&quot;fy21_varlist_g08.xls&quot;</span><span class="p">]</span>

<span class="c1"># 1. Match the dat file with its corresponding var file</span>
<span class="n">all_files</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat_files</span><span class="p">,</span> <span class="n">var_files</span><span class="p">)</span>

<span class="c1"># Create a list to concatenate the resulting grade level data frames later</span>
<span class="n">all_grades</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">dat_file</span><span class="p">,</span> <span class="n">var_file</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">dat_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">var_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing:&quot;</span><span class="p">,</span> <span class="n">dat_file</span><span class="p">,</span> <span class="s2">&quot;rows/cols:&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1"># 2. melt the dataframe (pivot wide to long) but keep all the site and grade identifiers out of the pivot</span>
    <span class="n">identifiers</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">variables</span><span class="o">.</span><span class="n">Format_Type</span> <span class="o">==</span> <span class="s1">&#39;Character&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Variable</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">identifier</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">]</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="n">id_vars</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pivoted:&quot;</span><span class="p">,</span> <span class="n">dat_file</span><span class="p">,</span> <span class="s2">&quot;rows/cols:&quot;</span><span class="p">,</span> <span class="n">test_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># 3. extract the subject and student groups</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">add_descriptors</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>

    <span class="c1"># 4. join the two dataset together using the variable name as the unique identifier</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Joined:&quot;</span><span class="p">,</span> <span class="n">dat_file</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">var_file</span><span class="p">,</span> <span class="s2">&quot;rows/cols:&quot;</span><span class="p">,</span> <span class="n">combined</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># 5. pivot back wide but with only the distinct variables</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">combined</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">combined</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;campus&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39;region&#39;</span><span class="p">,</span><span class="s1">&#39;district&#39;</span><span class="p">,</span><span class="s1">&#39;dname&#39;</span><span class="p">,</span><span class="s1">&#39;cname&#39;</span><span class="p">,</span><span class="s1">&#39;grade&#39;</span><span class="p">,</span><span class="s1">&#39;format_type&#39;</span><span class="p">,</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span><span class="s1">&#39;student_group&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">columns</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Combined:&quot;</span><span class="p">,</span> <span class="n">dat_file</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">var_file</span><span class="p">,</span> <span class="s2">&quot;rows/cols:&quot;</span><span class="p">,</span> <span class="n">combined</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># 6. append data for each grade into a single data structure and concatenate</span>
    <span class="n">all_grades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_grades</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final rows/cols:&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># 7. write to compressed csv</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;TX_STAAR_3_8_2021.csv.gz&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
Parsing: cfy21e3.dat rows/cols: (4643, 2093)
Pivoted: cfy21e3.dat rows/cols: (9685298, 9)
Joined: cfy21e3.dat + fy21_varlist_g03.xls rows/cols: (9685298, 13)
Combined: cfy21e3.dat + fy21_varlist_g03.xls rows/cols: (571089, 35)
WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
Parsing: cfy21e4.dat rows/cols: (4622, 3075)
Pivoted: cfy21e4.dat rows/cols: (14180296, 9)
Joined: cfy21e4.dat + fy21_varlist_g04.xls rows/cols: (14180296, 13)
Combined: cfy21e4.dat + fy21_varlist_g04.xls rows/cols: (850448, 35)
WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
Parsing: cfy21e5.dat rows/cols: (4415, 3197)
Pivoted: cfy21e5.dat rows/cols: (14083850, 9)
Joined: cfy21e5.dat + fy21_varlist_g05.xls rows/cols: (14083850, 13)
Combined: cfy21e5.dat + fy21_varlist_g05.xls rows/cols: (812360, 35)
WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
Parsing: cfy21e6.dat rows/cols: (2700, 2093)
Pivoted: cfy21e6.dat rows/cols: (5632200, 9)
Joined: cfy21e6.dat + fy21_varlist_g06.xls rows/cols: (5632200, 13)
Combined: cfy21e6.dat + fy21_varlist_g06.xls rows/cols: (332100, 35)
WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
Parsing: cfy21e7.dat rows/cols: (2337, 3075)
Pivoted: cfy21e7.dat rows/cols: (7169916, 9)
Joined: cfy21e7.dat + fy21_varlist_g07.xls rows/cols: (7169916, 13)
Combined: cfy21e7.dat + fy21_varlist_g07.xls rows/cols: (430008, 35)
WARNING *** OLE2 inconsistency: SSCS size is 0 but SSAT size is non-zero
Parsing: cfy21e8.dat rows/cols: (2370, 4301)
Pivoted: cfy21e8.dat rows/cols: (10176780, 9)
Joined: cfy21e8.dat + fy21_varlist_g08.xls rows/cols: (10176780, 13)
Combined: cfy21e8.dat + fy21_varlist_g08.xls rows/cols: (580650, 35)
Final rows/cols: (3576655, 35)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[44]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[44]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>name</th>
      <th>campus</th>
      <th>year</th>
      <th>region</th>
      <th>district</th>
      <th>dname</th>
      <th>cname</th>
      <th>grade</th>
      <th>format_type</th>
      <th>subject</th>
      <th>student_group</th>
      <th>...</th>
      <th>pct_answer_documents_submitted</th>
      <th>pct_approaches_grade_level_performance</th>
      <th>pct_avg_items_correctrpt_cat_1</th>
      <th>pct_avg_items_correctrpt_cat_2</th>
      <th>pct_avg_items_correctrpt_cat_3</th>
      <th>pct_avg_items_correctrpt_cat_4</th>
      <th>pct_did_not_meet_grade_level_performance</th>
      <th>pct_masters_grade_level_performance</th>
      <th>pct_meets_grade_level_performance</th>
      <th>pct_other_not_tested</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>001902103</td>
      <td>21</td>
      <td>07</td>
      <td>001902</td>
      <td>CAYUGA ISD</td>
      <td>CAYUGA ELEM.</td>
      <td>03</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>001902103</td>
      <td>21</td>
      <td>07</td>
      <td>001902</td>
      <td>CAYUGA ISD</td>
      <td>CAYUGA ELEM.</td>
      <td>03</td>
      <td>Numeric</td>
      <td>Mathematics</td>
      <td>All Students</td>
      <td>...</td>
      <td>100</td>
      <td>85</td>
      <td>79</td>
      <td>83</td>
      <td>71</td>
      <td>84</td>
      <td>15</td>
      <td>62</td>
      <td>73</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>001902103</td>
      <td>21</td>
      <td>07</td>
      <td>001902</td>
      <td>CAYUGA ISD</td>
      <td>CAYUGA ELEM.</td>
      <td>03</td>
      <td>Numeric</td>
      <td>Mathematics</td>
      <td>American Indian or Alaska Native Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>001902103</td>
      <td>21</td>
      <td>07</td>
      <td>001902</td>
      <td>CAYUGA ISD</td>
      <td>CAYUGA ELEM.</td>
      <td>03</td>
      <td>Numeric</td>
      <td>Mathematics</td>
      <td>Asian Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>001902103</td>
      <td>21</td>
      <td>07</td>
      <td>001902</td>
      <td>CAYUGA ISD</td>
      <td>CAYUGA ELEM.</td>
      <td>03</td>
      <td>Numeric</td>
      <td>Mathematics</td>
      <td>At-Risk Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>71</td>
      <td>64</td>
      <td>71</td>
      <td>47</td>
      <td>68</td>
      <td>29</td>
      <td>29</td>
      <td>43</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>580645</th>
      <td>254902001</td>
      <td>21</td>
      <td>20</td>
      <td>254902</td>
      <td>LA PRYOR ISD</td>
      <td>LA PRYOR H.S.</td>
      <td>08</td>
      <td>Numeric</td>
      <td>Social Studies</td>
      <td>Title-I Participant Students Codes: 6 7 9</td>
      <td>...</td>
      <td>NaN</td>
      <td>34</td>
      <td>41</td>
      <td>54</td>
      <td>42</td>
      <td>46</td>
      <td>66</td>
      <td>0</td>
      <td>11</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>580646</th>
      <td>254902001</td>
      <td>21</td>
      <td>20</td>
      <td>254902</td>
      <td>LA PRYOR ISD</td>
      <td>LA PRYOR H.S.</td>
      <td>08</td>
      <td>Numeric</td>
      <td>Social Studies</td>
      <td>Transitional Bilingual/Early Exit Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>580647</th>
      <td>254902001</td>
      <td>21</td>
      <td>20</td>
      <td>254902</td>
      <td>LA PRYOR ISD</td>
      <td>LA PRYOR H.S.</td>
      <td>08</td>
      <td>Numeric</td>
      <td>Social Studies</td>
      <td>Transitional Bilingual/Late Exit Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>580648</th>
      <td>254902001</td>
      <td>21</td>
      <td>20</td>
      <td>254902</td>
      <td>LA PRYOR ISD</td>
      <td>LA PRYOR H.S.</td>
      <td>08</td>
      <td>Numeric</td>
      <td>Social Studies</td>
      <td>Two or More Races Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>580649</th>
      <td>254902001</td>
      <td>21</td>
      <td>20</td>
      <td>254902</td>
      <td>LA PRYOR ISD</td>
      <td>LA PRYOR H.S.</td>
      <td>08</td>
      <td>Numeric</td>
      <td>Social Studies</td>
      <td>White Students</td>
      <td>...</td>
      <td>NaN</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>&lt;NA&gt;</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3576655 rows × 35 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">&#182;</a></h2><p>The resulting dataset/file ends up being ~3.5 million rows in length and a consistent 35 columns wide. You can download the reshaped dataset here: <a href="/extra/TX_STAAR_3_8_2021.csv.gz">TX STAAR 2021 - Grades 3-8</a></p>
<p>We can now run simpler queries on the reshaped data such as:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">TX_STAAR_2021</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Reading&#39;</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">student_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;All Students&#39;</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="n">grade</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;8&#39;</span><span class="p">)</span><span class="w"></span>
</pre></div>
<p>A similar query using the original datasets would've required unioning three different datasets and a much more complicated set of column matching to filter down to the right subject and student group.</p>
<p>In our production environment, the approach is similar but we initially load the raw dat and var files into Google Cloud Storage and as well as the resulting csv. That is then converted to avro for better query performance and an <a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-avro">external table</a> is generated in BigQuery using their API.</p>

</div>
</div>
</div>
 


<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " dchess ",
  "url" : ".",
  "image": "/images/profile.jpg",
  "description": "Code, code, and more code"
}
</script>

</body>
</html>